<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.1/full/pyodide.js"></script>
  </head>

  <body>
    <p>
      You can execute any Python code. Just enter something in the box below and
      click the button.
    </p>
    <!-- <input id="code" value="sum([1, 2, 3, 4, 5])" /> -->
    <div>
      <button onclick="Run()">Run</button>
      <!-- <button id="start/stop button" , onclick="Start()">Start</button> -->
      <input
        id="start/stop button"
        type="button"
        value="Start"
        onclick="Start()"
      />
      <button onclick="Next()">Next</button>
      <button onclick="Over()">Over</button>
    </div>
    <textarea id="code" style="width: 50%" rows="10">
sum([1, 2, 3, 4, 5])</textarea
    >
    <br />
    <br />
    <div>Output:</div>
    <textarea id="output" style="width: 100%" rows="20" disabled></textarea>

    <script>
      const output = document.getElementById("output");
      const code = document.getElementById("code");
      const button = document.getElementById("start/stop button");

      async function Run() {
        output.value = "Initializing...\n";
        pyodide = await loadPyodide();
        try {
          output.value = pyodide.runPython(code.value);
        } catch (err) {
          output.value = err;
        }
      }

      var _promote;
      var is_running = false;

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
      async function Start() {
        if (is_running) {
          is_running = false;
          _promote("stop");
          button.value = "Start";
          return;
        }
        is_running = true;
        button.value = "Stop";
        let hash = Math.floor(Math.random() * 1000);
        var type;

        output.value += hash + ": waiting...\n";
        while (true) {
          var promise = new Promise((resolve) => {
            _promote = resolve;
          });
          await promise.then((result) => {
            type = result;
          });
          // console.log("after .then");
          if (type === undefined) type = "Q";
          if (type == "next") output.value += hash + ": next!\n";
          else if (type == "over") output.value += hash + ": over!\n";
          else if (type == "stop") {
            output.value += hash + ": stopped\n";
            break;
          } else output.value = "unexpected: " + type;
          // await sleep(1000);
          output.value += hash + ": tick\n";
        }
      }

      async function Next() {
        _promote("next");
      }

      async function Over() {
        _promote("over");
      }

      async function Stop() {
        _promote("stop");
      }
    </script>
  </body>
</html>
